<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDF Scanner - Mobile</title>
    <link rel="stylesheet" href="src/mobile.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Cropper.js - defer loading for faster camera start -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <!-- jsPDF - defer loading -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Crop Modal Styles */
        .crop-modal {
            position: fixed;
            inset: 0;
            z-index: 1000;
            display: none;
            background: #000;
            flex-direction: column;
        }

        .crop-modal.active {
            display: flex;
        }

        .crop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
        }

        .crop-header h3 {
            font-size: 1rem;
            font-weight: 500;
            color: white;
        }

        .crop-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .crop-container img {
            max-width: 100%;
            max-height: 100%;
        }

        .crop-actions {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
        }

        .crop-actions button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-crop {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .crop-tools {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            justify-content: center;
        }

        .crop-tool-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .crop-tool-btn:active {
            background: rgba(255, 255, 255, 0.3);
        }

        .crop-tool-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Gallery improvements */
        .gallery-thumb {
            position: relative;
        }

        .thumb-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>ðŸ“± Document Scanner</h1>
            <div class="capture-count" id="capture-count">0 captured</div>
        </header>

        <!-- Camera View -->
        <main class="camera-section">
            <div class="camera-container" id="camera-container">
                <video id="camera-video" autoplay playsinline></video>
                <canvas id="capture-canvas" style="display: none;"></canvas>

                <!-- Camera overlay guides -->
                <div class="camera-overlay">
                    <div class="corner top-left"></div>
                    <div class="corner top-right"></div>
                    <div class="corner bottom-left"></div>
                    <div class="corner bottom-right"></div>
                </div>

                <!-- Loading state -->
                <div class="camera-loading" id="camera-loading">
                    <div class="spinner"></div>
                    <p>Starting camera...</p>
                </div>

                <!-- Error state -->
                <div class="camera-error" id="camera-error" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="8" x2="12" y2="12" />
                        <line x1="12" y1="16" x2="12.01" y2="16" />
                    </svg>
                    <p id="error-message">Camera access denied</p>
                    <button class="btn btn-primary" id="retry-btn">Try Again</button>
                </div>
            </div>

            <!-- Capture Controls -->
            <div class="capture-controls">
                <!-- Gallery button -->
                <label class="gallery-btn" id="gallery-btn">
                    <input type="file" accept="image/*" multiple id="file-input" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                        <circle cx="8.5" cy="8.5" r="1.5" />
                        <polyline points="21 15 16 10 5 21" />
                    </svg>
                </label>

                <!-- Capture button -->
                <button class="capture-btn" id="capture-btn" disabled>
                    <div class="capture-btn-inner"></div>
                </button>

                <!-- Generate PDF button -->
                <button class="done-btn" id="generate-pdf-btn"
                    style="background: linear-gradient(135deg, #10b981, #059669);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                </button>
            </div>
            <p class="capture-hint">Capture images â†’ Crop â†’ Generate PDF</p>
        </main>

        <!-- Image Gallery Preview -->
        <div class="mobile-gallery" id="mobile-gallery" style="display: none;">
            <div class="gallery-header">
                <span id="gallery-count">0 images</span>
                <button class="btn btn-secondary btn-small" id="clear-all-btn">Clear All</button>
            </div>
            <div class="gallery-scroll" id="gallery-scroll"></div>
        </div>

        <!-- Toast Messages -->
        <div class="upload-toast" id="upload-toast">
            <div class="upload-progress" id="upload-progress"></div>
            <span id="upload-message">Processing...</span>
        </div>
        <div class="success-toast" id="success-toast">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12" />
            </svg>
            <span id="success-message">Photo captured!</span>
        </div>
    </div>

    <!-- Crop Modal -->
    <div class="crop-modal" id="crop-modal">
        <div class="crop-header">
            <h3>Adjust Image</h3>
            <span id="crop-status">Drag to crop</span>
        </div>
        <div class="crop-container">
            <img id="crop-image" src="" alt="Crop preview">
        </div>
        <div class="crop-tools">
            <button class="crop-tool-btn" id="rotate-left-btn" title="Rotate Left">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="1 4 1 10 7 10" />
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
                </svg>
            </button>
            <button class="crop-tool-btn" id="rotate-right-btn" title="Rotate Right">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10" />
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                </svg>
            </button>
            <button class="crop-tool-btn" id="reset-btn" title="Reset">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" />
                </svg>
            </button>
        </div>
        <div class="crop-actions">
            <button class="btn-cancel" id="crop-cancel-btn">Cancel</button>
            <button class="btn-crop" id="crop-save-btn">Save</button>
        </div>
    </div>

    <script>
        class StandaloneMobileScanner {
            constructor() {
                this.images = [];
                this.stream = null;
                this.cropper = null;
                this.tempImageData = null;
                this.init();
            }

            async init() {
                await this.startCamera();
                this.bindEvents();
            }

            async startCamera() {
                const video = document.getElementById('camera-video');
                const loading = document.getElementById('camera-loading');
                const error = document.getElementById('camera-error');
                const captureBtn = document.getElementById('capture-btn');

                try {
                    // Use simpler constraints for faster camera start
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment'
                        },
                        audio: false
                    });

                    video.srcObject = this.stream;

                    // Enable capture button immediately
                    video.onloadedmetadata = () => {
                        loading.style.display = 'none';
                        captureBtn.disabled = false;
                    };

                    // Play video in case autoplay is blocked
                    video.play().catch(() => { });

                } catch (err) {
                    console.error('Camera access error:', err);
                    loading.style.display = 'none';
                    error.style.display = 'flex';
                    document.getElementById('error-message').textContent =
                        err.name === 'NotAllowedError' ? 'Please allow camera access' :
                            err.name === 'NotFoundError' ? 'No camera found' : 'Camera access denied';
                }
            }

            captureImage() {
                const video = document.getElementById('camera-video');
                const canvas = document.getElementById('capture-canvas');

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                this.tempImageData = canvas.toDataURL('image/jpeg', 0.9);
                this.showFlash();
                this.openCropModal(this.tempImageData);
            }

            showFlash() {
                const flash = document.createElement('div');
                flash.className = 'flash-overlay';
                document.body.appendChild(flash);
                setTimeout(() => flash.remove(), 300);
            }

            openCropModal(imageData) {
                const modal = document.getElementById('crop-modal');
                const cropImage = document.getElementById('crop-image');

                cropImage.src = imageData;
                modal.classList.add('active');

                // Wait for image to load then init cropper
                cropImage.onload = () => {
                    if (this.cropper) {
                        this.cropper.destroy();
                    }
                    this.cropper = new Cropper(cropImage, {
                        viewMode: 1,
                        dragMode: 'move',
                        aspectRatio: NaN, // Free aspect ratio
                        autoCropArea: 0.9,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        background: false,
                    });
                };
            }

            closeCropModal() {
                const modal = document.getElementById('crop-modal');
                modal.classList.remove('active');
                if (this.cropper) {
                    this.cropper.destroy();
                    this.cropper = null;
                }
            }

            saveCroppedImage() {
                if (!this.cropper) return;

                const canvas = this.cropper.getCroppedCanvas({
                    maxWidth: 2000,
                    maxHeight: 2000,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high',
                });

                const croppedData = canvas.toDataURL('image/jpeg', 0.85);

                this.images.push({
                    id: Date.now(),
                    data: croppedData
                });

                this.closeCropModal();
                this.updateUI();
                this.showSuccessToast('Image saved!');
            }

            updateUI() {
                const countEl = document.getElementById('capture-count');
                const galleryCountEl = document.getElementById('gallery-count');
                const galleryEl = document.getElementById('mobile-gallery');
                const scrollEl = document.getElementById('gallery-scroll');

                countEl.textContent = `${this.images.length} captured`;
                galleryCountEl.textContent = `${this.images.length} images`;

                if (this.images.length > 0) {
                    galleryEl.style.display = 'block';
                    scrollEl.innerHTML = this.images.map((img, i) => `
                    <div class="gallery-thumb" data-id="${img.id}">
                        <img src="${img.data}" alt="Image ${i + 1}">
                        <span class="thumb-number">${i + 1}</span>
                        <button class="thumb-delete" data-id="${img.id}">Ã—</button>
                    </div>
                `).join('');

                    // Add delete handlers
                    scrollEl.querySelectorAll('.thumb-delete').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.deleteImage(parseInt(btn.dataset.id));
                        });
                    });

                    // Add click to edit handlers
                    scrollEl.querySelectorAll('.gallery-thumb').forEach(thumb => {
                        thumb.addEventListener('click', () => {
                            const img = this.images.find(i => i.id == thumb.dataset.id);
                            if (img) this.editImage(img);
                        });
                    });
                } else {
                    galleryEl.style.display = 'none';
                }
            }

            deleteImage(id) {
                // Use loose equality to handle string/number type mismatch
                this.images = this.images.filter(img => img.id != id);
                this.updateUI();
            }

            editImage(img) {
                // Store index for later replacement
                this.editingImageId = img.id;
                this.openCropModal(img.data);
            }

            showSuccessToast(message) {
                const toast = document.getElementById('success-toast');
                document.getElementById('success-message').textContent = message;
                toast.classList.add('active');
                setTimeout(() => toast.classList.remove('active'), 2000);
            }

            async handleFileSelect(files) {
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.tempImageData = e.target.result;
                            this.openCropModal(this.tempImageData);
                        };
                        reader.readAsDataURL(file);
                        break; // Handle one at a time for cropping
                    }
                }
            }

            clearAll() {
                if (confirm('Clear all images?')) {
                    this.images = [];
                    this.updateUI();
                }
            }

            async generatePDF() {
                if (this.images.length === 0) {
                    alert('No images to convert. Capture some photos first!');
                    return;
                }

                const toast = document.getElementById('upload-toast');
                document.getElementById('upload-message').textContent = 'Generating PDF...';
                toast.classList.add('active');

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 10;

                    for (let i = 0; i < this.images.length; i++) {
                        if (i > 0) doc.addPage();

                        const imgProps = await this.getImageDimensions(this.images[i].data);

                        const maxWidth = pageWidth - margin * 2;
                        const maxHeight = pageHeight - margin * 2;

                        let width = imgProps.width;
                        let height = imgProps.height;
                        const scale = Math.min(maxWidth / width, maxHeight / height);
                        width *= scale;
                        height *= scale;

                        const x = (pageWidth - width) / 2;
                        const y = (pageHeight - height) / 2;

                        doc.addImage(this.images[i].data, 'JPEG', x, y, width, height);
                    }

                    toast.classList.remove('active');
                    doc.save(`scanned-${new Date().toISOString().slice(0, 10)}.pdf`);
                    this.showSuccessToast('PDF downloaded!');

                } catch (error) {
                    console.error('PDF error:', error);
                    toast.classList.remove('active');
                    alert('Failed to generate PDF: ' + error.message);
                }
            }

            getImageDimensions(dataUrl) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve({ width: img.width, height: img.height });
                    img.onerror = reject;
                    img.src = dataUrl;
                });
            }

            bindEvents() {
                // Camera
                document.getElementById('capture-btn').addEventListener('click', () => this.captureImage());
                document.getElementById('generate-pdf-btn').addEventListener('click', () => this.generatePDF());
                document.getElementById('clear-all-btn').addEventListener('click', () => this.clearAll());

                document.getElementById('file-input').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFileSelect(e.target.files);
                        e.target.value = '';
                    }
                });

                document.getElementById('retry-btn').addEventListener('click', () => {
                    document.getElementById('camera-error').style.display = 'none';
                    document.getElementById('camera-loading').style.display = 'flex';
                    this.startCamera();
                });

                // Crop modal
                document.getElementById('crop-cancel-btn').addEventListener('click', () => this.closeCropModal());
                document.getElementById('crop-save-btn').addEventListener('click', () => {
                    if (this.editingImageId) {
                        // Replace existing image
                        const canvas = this.cropper.getCroppedCanvas({ maxWidth: 2000, maxHeight: 2000 });
                        const croppedData = canvas.toDataURL('image/jpeg', 0.85);
                        const img = this.images.find(i => i.id === this.editingImageId);
                        if (img) img.data = croppedData;
                        this.editingImageId = null;
                        this.closeCropModal();
                        this.updateUI();
                        this.showSuccessToast('Image updated!');
                    } else {
                        this.saveCroppedImage();
                    }
                });

                // Rotate buttons
                document.getElementById('rotate-left-btn').addEventListener('click', () => {
                    if (this.cropper) this.cropper.rotate(-90);
                });
                document.getElementById('rotate-right-btn').addEventListener('click', () => {
                    if (this.cropper) this.cropper.rotate(90);
                });
                document.getElementById('reset-btn').addEventListener('click', () => {
                    if (this.cropper) this.cropper.reset();
                });

                window.addEventListener('beforeunload', () => {
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => new StandaloneMobileScanner());
    </script>
</body>

</html>